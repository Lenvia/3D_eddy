<!DOCTYPE html>
<html lang="en">
	<head>
		<title>eddies - vtk loader</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	</head>

	<body>
		<script type="text/javascript" src="./node_modules/jquery/dist/jquery.min.js"></script>
		<script type="module">

			import * as THREE from './node_modules/three/build/three.module.js';

			import Stats from './node_modules/three/examples/jsm/libs/stats.module.js';

			import { TrackballControls } from './node_modules/three/examples/jsm/controls/TrackballControls.js';
			// import { VTKLoader } from './examples/jsm/loaders/VTKLoader.js';
			import { VTKLoader } from './VTKLoader.js';

			let container, stats;

			let camera, controls, scene, renderer;

			init();
			animate();

			function init() {
				var width = window.innerWidth; //窗口宽度
    			var height = window.innerHeight; //窗口高度

				scene = new THREE.Scene();

				// 设置相机（正投影）
				var k = width / height; //窗口宽高比
    			var s = 100; //三维场景显示范围控制系数，系数越大，显示的范围越大

				camera = new THREE.OrthographicCamera(-s * k, s * k, s, -s, 1, 1000);
    			camera.position.set(100, 150, 100); //设置相机位置
				scene.add( camera );

				//平行光
				const dirLight = new THREE.DirectionalLight( 0xffffff, 1 );
				dirLight.position.set( 2, 2, 2 );
				scene.add( dirLight );
				//环境光
				var ambient = new THREE.AmbientLight(0x444444);
				scene.add(ambient);


				//辅助坐标系
				var axesHelper = new THREE.AxesHelper(150);
				scene.add(axesHelper);
	
				//获取单个涡旋的n天json列表
				var start_day = 4;
				var start_index = 13;
				var identifier = String(start_day)+'-'+String(start_index);
				var json_path = ("./track/".concat(identifier, ".json"));
				let data;

				$.ajax({
					url: json_path,//json文件位置
					type: "GET",//请求方式为get
					dataType: "json", //返回数据格式为json
					async: false,  // 同步
					success: function(res) {//请求成功完成后要执行的方法 
						data = res;
					}
				})
				
				// 载入该涡旋所有时间内的vtk数据
				var indices = data["indices"];
				var days = data["days"];
				var geoArr = [];
				for( var i =0; i<indices.length; i++){
					if(indices[i]==-1)
						continue;
					// console.log(indices[i]);

					var site = String(days[i]) + "_0_" + String(indices[i]);
					var vtk_path = ("./vtk_folder/".concat(identifier, "/vtk", site, ".vtk"));

					const loader = new VTKLoader();
					loader.load( vtk_path, function ( geometry ) {
					
						geometry.center();
						// geometry.computeVertexNormals();

						const material = new THREE.LineBasicMaterial( { color: 0xffffff } );
						var linesG = new THREE.LineSegments(geometry, material);
						linesG.scale.multiplyScalar( 50 );
						scene.add(linesG)

						geoArr.push(geoArr);
						// console.log(geometry);

					} );
				}
				
				console.log(geoArr);


				

				// renderer
				renderer = new THREE.WebGLRenderer();
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( width, height );
				renderer.setClearColor(0x52576e, 1); //设置背景颜色

				container = document.createElement( 'div' );
				document.body.appendChild( container );
				container.appendChild( renderer.domElement );

				// controls
				controls = new TrackballControls( camera, renderer.domElement );
				controls.minDistance = .1;
				controls.maxDistance = 0.5;
				controls.rotateSpeed = 2.0;  // 旋转速度
				controls.staticMoving = false;  // 不开启移动惯性

				stats = new Stats();
				container.appendChild( stats.dom );

				window.addEventListener( 'resize', onWindowResize, false );

			}

			// 窗口变动触发函数
			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

				controls.handleResize();

			}

			function animate() {

				requestAnimationFrame( animate );

				controls.update(); //更新控制器

				renderer.render( scene, camera );

				stats.update();

			}

		</script>

	</body>
</html>
